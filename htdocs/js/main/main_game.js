enchant();
var character;
var map;
window.onload = function() {
  var x = window.innerWidth / 100 * 35;
  var y = window.innerHeight / 100 * 55;
  var side = ( x > y ) ? y : x;
  // console.log(x + ":" + y);
  var game = new Core(512, 512);


  var charaImage  = "/src/character.png";
  var mapImage    = "/src/map0.gif";
  game.preload(charaImage, mapImage);

  game.onload = function(){
    // マップ====================================================
    map = new Map(32, 32);
    map.image = game.assets[mapImage];
    map.loadData([
    [33,33,33,33,33,33,33,33,33,33,33,33,33,33,33,33],
    [33,20,20,20,20,20,20,20,20,20,20,20,20,20,20,33],
    [33,20,20,100,100,100,100,100,100,100,100,100,100,100,20,33],
    [33,20,20,20,20,20,20,20,20,20,20,20,20,100,20,33],
    [33,20,20,20,20,20,20,20,20,20,20,20,20,100,20,33],
    [33,20,20,20,20,100,100,100,100,100,100,100,20,100,20,33],
    [33,20,20,20,20,100,20,20,20,20,20,100,20,100,20,33],
    [33,20,20,20,20,100,20,20,20,20,20,100,20,100,20,33],
    [33,20,20,20,20,100,20,20,100,100,100,100,20,100,20,33],
    [33,20,20,20,20,100,20,20,20,20,20,20,20,100,20,33],
    [33,20,20,20,20,100,20,20,20,20,20,20,20,100,20,33],
    [33,20,20,20,20,100,100,100,100,100,100,100,100,100,20,33],
    [33,20,20,20,20,20,20,20,20,20,20,20,20,20,20,33],
    [33,20,20,20,20,20,20,20,20,20,20,20,20,20,20,33],
    [33,33,33,33,33,33,33,33,33,33,33,33,33,33,33,33],
    [33,33,33,33,33,33,33,33,33,33,33,33,33,33,33,33]
],[
    [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
    [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
    [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
    [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
    [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
    [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
    [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
    [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
    [-1,-1,-1,-1,-1,-1,-1,-1,27,-1,-1,-1,-1,-1,-1,-1],
    [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
    [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
    [-1,-1,-1,59,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
    [-1,-1,-1,75,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
    [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
    [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
    [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1]
]);
map.collisionData = [
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1],
    [1,1,1,1,1,0,0,0,0,0,0,0,1,0,1,1],
    [1,1,1,1,1,0,1,1,1,1,1,0,1,0,1,1],
    [1,1,1,1,1,0,1,1,1,1,1,0,1,0,1,1],
    [1,1,1,1,1,0,1,1,0,0,0,0,1,0,1,1],
    [1,1,1,1,1,0,1,1,1,1,1,1,1,0,1,1],
    [1,1,1,1,1,0,1,1,1,1,1,1,1,0,1,1],
    [1,1,1,1,1,0,0,0,0,0,0,0,0,0,1,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
];


    game.rootScene.addChild(map);
    //==========================================================

    var sprite = new Sprite(side, side);
    sprite.x = 0;
    sprite.y = 0;
    var surface = new Surface(side, side);
    sprite.image = surface;
    var ctx = surface.context;
    ctx.strokeStyle = "rgb(0, 0, 0)";
    ctx.strokeRect(0, 0, x , x);
    ctx.stroke();


    character = new Sprite(32, 32);
    character.image = game.assets[charaImage];
    character.animeWaitMax = 3;
    character.animeWaitCount = 0;

    //characterの初期設定
    character.startDirection = 1;
    character.startX = 3 * 32;
    character.startY = 2 * 32;

    reset();

    game.rootScene.addChild(character);
    // game.rootScene.addChild(sprite);

    game.scale = side / 512;
    $("#enchant-stage").css("margin-left", ( x > side ) ? (x - y) / 2 : 10);

    $("#buttons").css("margin-top", side + 10);
    $("#buttons").css("margin-left", ( x > side ) ? (x - y) / 2 : 10);
    $("#buttons").css("width", side);

    $("#console").css("margin-top", side + 80);
    $("#console").css("margin-left", ( x > side ) ? (x - y) / 2 : 10);
    $("#console").css("width", side);
    $("#console").css("height", window.innerHeight - side - 180);

  };

  game.start();
  window.scrollTo(0, 0);
};

function reset() {
  stopCode();
  character.x = character.startX;
  character.y = character.startY;
  character.direction = character.startDirection;
  character.frame = character.direction * 3;

  $("#console").val("");
}
